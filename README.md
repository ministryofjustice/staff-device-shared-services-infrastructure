[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=flat&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fstaff-device-shared-services-infrastructure&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#staff-device-shared-services-infrastructure)

# MoJ Official Shared Services Infrastructure

This creates the shared infrastructure for the main account, named Shared Services. This account is used to host AWS CodePipeline CI/CD pipelines, for new CI/CD use [GitHub Actions](#CI-CD-with-GitHub-Actions) as per [ADR 011][ADR 011].

For the code that creates infrastructure for each environment please see [this repository](https://github.com/ministryofjustice/staff-device-logging-infrastructure), as an example.


This repository holds the Terraform code to create a [CodeBuild](https://aws.amazon.com/codebuild/) / [CodePipeline](https://aws.amazon.com/codepipeline/) service in AWS.

## Applying the terraform

You will require Docker

To apply the Terraform in this project using [AWS Vault](https://github.com/99designs/aws-vault) to authenticate:


1. Prepare your working directory for Terraform

```shell
make init
```
2. Check the changes in with a plan

```shell
 make plan
 ```
3. Apply the changes

```shell
make apply
```

To view all the available target commands in the Makefile just type

```shell
make
```

## How to use this repo

The source code in this repository is provided only as a reference.

Please consult with someone on the Cloud Ops team before you use this repository to have a pipeline set up for your own project.

The pipeline you set will be integrated with a GitHub repository, and will build your project according to your [buildspec](https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html) files.

This repository upon execution will create a couple of s3 buckets and a DynamoDB table. So, if your project uses Terraform, make sure that the backend for that Terraform is configured to use the newly created s3 bucket and the DynamoDB table.

Depending on your build process, you may require 3 files to do linting, testing and deployment.

### Linting

If you are doing static code analysis as part of your build, please create a `buildspec.lint.yml` file, and place it in the root of your project.

example:

```yaml
version: 0.2

phases:
  install:
    commands:
      - make lint
```

### Testing

To run automated tests, create a `buildspec.test.yml` file, and place it in the root of your project.

example:

```yaml
version: 0.2

phases:
  install:
    commands:
      - make test
```

### Deployment

For deployments, create a `buildspec.yml` file.

example:

```yaml
version: 0.2

env:
  variables:
    key: "value"
    key: "value"

phases:
  install:
    commands:
      - pip install boto3
      - wget https://releases.hashicorp.com/terraform/0.12.24/terraform_0.12.24_linux_amd64.zip
      - unzip terraform_0.12.24_linux_amd64.zip
      - mv terraform /bin
      - terraform init
  build:
    commands:
      - terraform apply --auto-approve
```

## To create your own Pipeline

To have a Pipeline for your own project with AWS CodePipeline / CodeBuild, you can execute the Terraform in this repository.

Re-use the module `./modules/ci-pipeline` in the `main.tf` file to setup your own Pipeline. 

Run Terraform 

```shell script
make apply
```

## Secrets management

We use SSM Parameter store for all secrets.

These secrets are decrypted at build time on CI to inject into Terraform.

### To add or update a secret:

``` shell script
make shell

aws ssm put-parameter --name "/your/top/secret/name" \
  --key-id "kms key ID to encrypt with" \
  --description "Secret description" \
  --type SecureString \
  --value "tops3cr3t" \
  --overwrite
```

### Pipeline flags

2 flags exist for pipelines and can be turned on or off when invoking the pipeline module.

```
manual_production_deploy
```

This option adds a stage to the pipeline where manual confirmation is required before deploying to production.

```
production_plan
```

This option adds stage where changes to infrastructure can be inspected before applying. Typically used in combination with the `manual_production_deploy`. This will set an environment variable on the stage of `PLAN="true"`.
Buildspec files can be modified to look for the existence of this variable to do either a `terraform plan` or `terraform apply`.

## CI CD with GitHub Actions

We have the following repository which we use for [shared Actions](https://github.com/ministryofjustice/nvvs-devops-github-actions).

Following table displays all the repositories [nvvs-devops-admins](https://github.com/orgs/ministryofjustice/teams/nvvs-devops-admins) GithUb team have access to 

| Owner                  |REPO NAME                                          | AWS/Github       |Description  |
|------                  |---------                                          |-----------       |--------- 
| operations-engineering |aws-root-account                                   | Github           |Terraform for the Ministry of Justice AWS root account   |
| Gary H                 |aws-ta-testing                                     | Delete?          |Terraform for testing|                                 
| nvvs-devops-admins     |aws-trusted-advisor-to-github-issues               | Github           | Automates creation of GitHub Issues from AWS Trusted Advisor checks|
| nvvs-devops-admins     |cloud-operations-slack-bot                         | Github           | Official Slack bot app for Cloud Operations team Slack channel |
| nvvs-devops-admins     |deployment-tgw                                     | Manual?          |   |                                
| nvvs-devops-admins     |mojo-aws-github-oidc-provider                      | Manual?          |To manage GitHub AWS OpenID Connector provider on MoJO AWS Shared Services account.|
| nvvs-devops-admins     |network-access-control-admin                       | AWS CodePipeline |Self service admin portal for the Network Access Control Service |
| nvvs-devops-admins     |network-access-control-disaster-recovery           | Manual?          |Rollback scripts for S3 configuration and ECR containers|
| nvvs-devops-admins     |network-access-control-infrastructure              | AWS CodePipeline |Terraform infrastructure for the 802.1x Network Access Control Service|
| nvvs-devops-admins     |network-access-control-integration-tests           | Manual?          |Integration tests for the Network Access Control Service|
| nvvs-devops-admins     |network-access-control-server                      | AWS CodePipeline |FreeRadius server for the 802.1x Network Access Control Service|
| nvvs-devops-admins     |nvvs-devops                                        | Github           |Documentation for the NVVS DevOps Team|
| nvvs-devops-admins     |nvvs-devops-github-actions                         | Github           |Used for Workflow GitHub actions from other repositories|
| nvvs-devops-admins     |nvvs-devops-monitor                                | Github           |Terraform to create new VPC and EKS Cluster for the MoJO IMA|
| nvvs-devops-admins     |PaloAlto-pipelines                                 | Manual ??        |Terraform configuration to manage AWS CodePipelines |
| nvvs-devops-admins     |provision-ubuntu2004-on-wsl2                       | Manual (y)       |Automating provisoning ubuntu 20.04 with Ansible on WSL 2|
| nvvs-devops-admins     |staff-device-dhcp-server                           | AWS CodePipeline |The ISC KEA server for serving DHCP requests (via a Docker image)|
| nvvs-devops-admins     |staff-device-dns-dhcp-admin                        | AWS CodePipeline |Web frontend for managing Staff Device DNS / DHCP servers|
| nvvs-devops-admins     |staff-device-dns-dhcp-disaster-recovery            | Manual ?         |Disaster recovery script for DNS and DHCP services.|
| nvvs-devops-admins     |staff-device-dns-dhcp-infrastructure               | AWS CodePipeline |Staff Device DHCP and DNS Terraform infrastructure|
| nvvs-devops-admins     |staff-device-dns-server                            | AWS CodePipeline |Staff Device DNS Server repository|
| nvvs-devops-admins     |staff-device-logging-dns-dhcp-integration-tests    | Manual (y)       |Remote full stack integration tests currently run from Corsham test site. Services being |tested include Security Logging, DHCP and DNS.|
| nvvs-devops-admins     |staff-device-logging-infrastructure                | AWS CodePipeline |Log proxy and forwarding infrastructure|
| nvvs-devops-admins     |staff-device-logging-syslog-to-cloudwatch          | AWS CodePipeline |Docker container to forward syslog events to CloudWatch|
| nvvs-devops-admins     |staff-device-management-intune-scripts             | ??               |Scripts that are deployed to run on MoJ OFFICIAL devices managed through Microsoft Intune|
| nvvs-devops-admins     |staff-device-private-dns-zone                      | Github           |This repository contains the Terraform code to create and maintain private DNS zones in AWS Route 53.|
| nvvs-devops-admins     |staff-device-shared-services-infrastructure        | Manual           |Staff Device AWS Infrastructure for build pipelines|
| nvvs-devops-admins     |staff-infrastructure-admin-sso                     | Not Applicable   |Terraform management of AzureAD Users and Groups for staff management services|
| nvvs-devops-admins     |staff-infrastructure-certificate-services          | Github           |Infrastructure to support Public Key Infrastructure for devices users and applications|
| nvvs-devops-admins     |staff-infrastructure-metric-aggregation-server     | Github           |This repository is for building our custom prometheus docker image with all the required config to pull data from our collectors |
| nvvs-devops-admins     |staff-infrastructure-metric-aggregator-cloud       | Not Applicable   |Prometheus server for AWS Cloudwatch and Azure Monitor Exporters|
| nvvs-devops-admins     |staff-infrastructure-monitoring-app-reachability   | Github           |Lightweight all-in-one docker image for monitoring http endpoints and shipping metrics back to a central prometheus over the internet.|
| nvvs-devops-admins     |staff-infrastructure-monitoring-blackbox-exporter  | Manual ??        |This project is part of the Infrastructure Monitoring and Alerting (IMA) Platform. It holds the Docker image for pulling data from the Physical Devices.|
| nvvs-devops-admins     |staff-infrastructure-monitoring-dns-reachability   | Manual ??        |To monitor MoJ Official DNS|
| nvvs-devops-admins     |staff-infrastructure-monitoring-snmpexporter       | Manual ??        |This is an exporter that exposes information gathered from SNMP to be scraped by Prometheus.|
| nvvs-devops-admins     |staff-infrastructure-network-operations            | Manual ??        |Repository for Network Operations Centre tooling|
| nvvs-devops-admins     |staff-infrastructure-network-services              | AWS CodePipeline |This repository deploys the underlying base infrastructure for several network based services for staff devices and applications in a single VPC in AWS.|
| nvvs-devops-admins     |staff-infrastructure-smtp-relay-server             | AWS CodePipeline |This repository builds the docker image for the SMTP Relay server and pushes it to the Shared Services Elastic Container Repository|
| nvvs-devops-admins     |staff-technology-services-github-teams             | Github           |To define and maintain some GitHub teams for Technology Services in Code using Terraform.|
| nvvs-devops-admins     |tech-docs-monitor                                  | Github           |Part of alphagov/tech-docs-template (issues 👉https://github.com/alphagov/tech-docs-template/issues)|
| nvvs-devops-admins     |terraform-panorama-config                          | Manual ??        | |
| nvvs-devops-admins     |transit-gateways                                   | Manual ??        | |


[ADR 011]: https://ministryofjustice.github.io/nvvs-devops/documentation/adrs/011-use-github-actions-for-ci-cd.html#011-use-github-actions-for-ci-cd
